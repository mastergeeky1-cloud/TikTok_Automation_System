#!/bin/bash
"""
Geeky Master Content Management Tool
TikTok Automation System - Content Generation & Management
"""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
PYTHON_SCRIPT="$PROJECT_ROOT/core/content/content_generator.py"
DATA_DIR="$PROJECT_ROOT/data"
MEDIA_DIR="$DATA_DIR/media"
LOG_DIR="$DATA_DIR/logs"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${timestamp} [${level}] ${message}" | tee -a "$LOG_DIR/content_manager.log"
}

# Check dependencies
check_dependencies() {
    local deps=("python3" "ffmpeg" "convert")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            log "ERROR" "Missing dependency: $dep"
            echo -e "${RED}Error: Missing dependency: $dep${NC}"
            echo "Please install the required packages:"
            echo "sudo apt update && sudo apt install -y python3 ffmpeg imagemagick"
            exit 1
        fi
    done
}

# Initialize directories
init_directories() {
    local dirs=("$MEDIA_DIR" "$LOG_DIR" "$DATA_DIR/templates" "$DATA_DIR/backups")
    for dir in "${dirs[@]}"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir"
            log "INFO" "Created directory: $dir"
        fi
    done
}

# Generate content
generate_content() {
    local topic="$1"
    local template="${2:-viral_facts}"
    local count="${3:-1}"
    
    log "INFO" "Generating content - Topic: $topic, Template: $template, Count: $count"
    
    if [ ! -f "$PYTHON_SCRIPT" ]; then
        log "ERROR" "Content generator script not found: $PYTHON_SCRIPT"
        echo -e "${RED}Error: Content generator script not found${NC}"
        exit 1
    fi
    
    # Check if OpenAI API key is configured
    if [ -z "$OPENAI_API_KEY" ]; then
        log "WARNING" "OpenAI API key not configured, using fallback content"
        echo -e "${YELLOW}Warning: OpenAI API key not configured${NC}"
        echo "Set OPENAI_API_KEY environment variable for AI-powered content"
    fi
    
    # Generate content
    echo -e "${BLUE}Generating $count content piece(s)...${NC}"
    
    cd "$PROJECT_ROOT"
    python3 "$PYTHON_SCRIPT" --topic="$topic" --template="$template" --count="$count"
    
    if [ $? -eq 0 ]; then
        log "SUCCESS" "Content generation completed"
        echo -e "${GREEN}✓ Content generation completed successfully${NC}"
    else
        log "ERROR" "Content generation failed"
        echo -e "${RED}✗ Content generation failed${NC}"
        exit 1
    fi
}

# List generated content
list_content() {
    log "INFO" "Listing generated content"
    
    echo -e "${BLUE}Generated Content:${NC}"
    echo "========================================"
    
    if [ -d "$MEDIA_DIR" ]; then
        local count=0
        for file in "$MEDIA_DIR"/*.mp4 "$MEDIA_DIR"/*.mov "$MEDIA_DIR"/*.avi; do
            if [ -f "$file" ]; then
                local filename=$(basename "$file")
                local filesize=$(du -h "$file" | cut -f1)
                local filedate=$(stat -c %y "$file" | cut -d' ' -f1,2 | cut -d'.' -f1)
                
                echo -e "${GREEN}File:${NC} $filename"
                echo -e "${BLUE}Size:${NC} $filesize"
                echo -e "${BLUE}Created:${NC} $filedate"
                echo "----------------------------------------"
                ((count++))
            fi
        done
        
        if [ $count -eq 0 ]; then
            echo -e "${YELLOW}No content files found${NC}"
        else
            echo -e "${GREEN}Total files: $count${NC}"
        fi
    else
        echo -e "${RED}Media directory not found${NC}"
    fi
}

# Schedule content for publishing
schedule_content() {
    local file_path="$1"
    local schedule_time="$2"
    local account="${3:-@default}"
    
    log "INFO" "Scheduling content - File: $file_path, Time: $schedule_time, Account: $account"
    
    if [ ! -f "$file_path" ]; then
        log "ERROR" "Content file not found: $file_path"
        echo -e "${RED}Error: Content file not found: $file_path${NC}"
        exit 1
    fi
    
    # Create schedule entry
    local schedule_file="$DATA_DIR/schedule.json"
    local timestamp=$(date -d "$schedule_time" +%s 2>/dev/null)
    
    if [ -z "$timestamp" ]; then
        log "ERROR" "Invalid time format: $schedule_time"
        echo -e "${RED}Error: Invalid time format. Use: YYYY-MM-DD HH:MM or 'now + 1 hour'${NC}"
        exit 1
    fi
    
    # Initialize schedule file if it doesn't exist
    if [ ! -f "$schedule_file" ]; then
        echo '{"scheduled_posts": []}' > "$schedule_file"
    fi
    
    # Add to schedule (using jq for JSON manipulation)
    local temp_file=$(mktemp)
    jq --arg file "$file_path" \
       --arg time "$timestamp" \
       --arg account "$account" \
       '.scheduled_posts += [{"file": $file, "scheduled_time": ($time | tonumber), "account": $account, "status": "scheduled"}]' \
       "$schedule_file" > "$temp_file"
    mv "$temp_file" "$schedule_file"
    
    # Create cron job for publishing
    local cron_entry="$(date -d "@$timestamp" '+%M %H %d %m *') cd $PROJECT_ROOT && ./scripts/automation/gm-publish --file='$file_path' --account='$account'"
    (crontab -l 2>/dev/null; echo "$cron_entry") | crontab -
    
    log "SUCCESS" "Content scheduled successfully"
    echo -e "${GREEN}✓ Content scheduled for publishing${NC}"
    echo -e "${BLUE}File:${NC} $file_path"
    echo -e "${BLUE}Scheduled for:${NC} $(date -d "@$timestamp" '+%Y-%m-%d %H:%M:%S')"
    echo -e "${BLUE}Account:${NC} $account"
}

# Publish content immediately
publish_content() {
    local file_path="$1"
    local account="${2:-@default}"
    
    log "INFO" "Publishing content - File: $file_path, Account: $account"
    
    if [ ! -f "$file_path" ]; then
        log "ERROR" "Content file not found: $file_path"
        echo -e "${RED}Error: Content file not found: $file_path${NC}"
        exit 1
    fi
    
    # Call the publishing script
    if [ -f "$SCRIPT_DIR/gm-publish" ]; then
        "$SCRIPT_DIR/gm-publish" --file="$file_path" --account="$account"
    else
        log "WARNING" "Publishing script not found, simulating publish"
        echo -e "${YELLOW}Publishing script not found, simulating publish...${NC}"
        echo -e "${BLUE}File:${NC} $file_path"
        echo -e "${BLUE}Account:${NC} $account"
        echo -e "${GREEN}✓ Published (simulated)${NC}"
    fi
}

# Create content template
create_template() {
    local name="$1"
    local category="$2"
    local duration="$3"
    local style="$4"
    
    log "INFO" "Creating template - Name: $name, Category: $category, Duration: $duration, Style: $style"
    
    local template_file="$DATA_DIR/templates/${name}.json"
    local template_data="{
        \"name\": \"$name\",
        \"category\": \"$category\",
        \"duration\": $duration,
        \"style\": \"$style\",
        \"has_audio\": true,
        \"text_overlay\": true,
        \"transitions\": [\"fade\", \"slide\", \"zoom\"]
    }"
    
    echo "$template_data" > "$template_file"
    
    log "SUCCESS" "Template created: $template_file"
    echo -e "${GREEN}✓ Template created successfully${NC}"
    echo -e "${BLUE}Template file:${NC} $template_file"
}

# List available templates
list_templates() {
    log "INFO" "Listing available templates"
    
    echo -e "${BLUE}Available Templates:${NC}"
    echo "========================================"
    
    if [ -d "$DATA_DIR/templates" ]; then
        local count=0
        for template in "$DATA_DIR/templates"/*.json; do
            if [ -f "$template" ]; then
                local name=$(jq -r '.name' "$template" 2>/dev/null || echo "Unknown")
                local category=$(jq -r '.category' "$template" 2>/dev/null || echo "Unknown")
                local duration=$(jq -r '.duration' "$template" 2>/dev/null || echo "Unknown")
                local style=$(jq -r '.style' "$template" 2>/dev/null || echo "Unknown")
                
                echo -e "${GREEN}Template:${NC} $name"
                echo -e "${BLUE}Category:${NC} $category"
                echo -e "${BLUE}Duration:${NC} ${duration}s"
                echo -e "${BLUE}Style:${NC} $style"
                echo "----------------------------------------"
                ((count++))
            fi
        done
        
        if [ $count -eq 0 ]; then
            echo -e "${YELLOW}No templates found${NC}"
        else
            echo -e "${GREEN}Total templates: $count${NC}"
        fi
    else
        echo -e "${RED}Templates directory not found${NC}"
    fi
}

# Show help
show_help() {
    echo -e "${BLUE}Geeky Master Content Management Tool${NC}"
    echo ""
    echo "Usage: $0 [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo "  generate --topic=<topic> [--template=<name>] [--count=<n>]   Generate new content"
    echo "  list                                                       List generated content"
    echo "  schedule --file=<path> --time=<datetime> [--account=@user] Schedule content"
    echo "  publish --file=<path> [--account=@user]                   Publish content immediately"
    echo "  template --create --name=<name> --category=<cat> --duration=<sec> --style=<style>  Create template"
    echo "  templates                                                  List available templates"
    echo "  help                                                       Show this help"
    echo ""
    echo "Examples:"
    echo "  $0 generate --topic='AI technology' --template=viral_facts --count=5"
    echo "  $0 schedule --file='./data/media/video_20240101_120000.mp4' --time='2024-01-01 18:00'"
    echo "  $0 publish --file='./data/media/video_20240101_120000.mp4' --account=@myusername"
    echo "  $0 template --create --name=my_template --category=tech --duration=30 --style=professional"
}

# Main execution
main() {
    # Create log directory
    mkdir -p "$LOG_DIR"
    
    # Check dependencies
    check_dependencies
    
    # Initialize directories
    init_directories
    
    # Parse command
    case "${1:-help}" in
        "generate")
            if [[ "$2" == --topic=* ]]; then
                local topic="${2#--topic=}"
                local template="viral_facts"
                local count=1
                
                # Parse optional arguments
                shift 2
                while [[ $# -gt 0 ]]; do
                    case $1 in
                        --template=*)
                            template="${1#--template=}"
                            ;;
                        --count=*)
                            count="${1#--count=}"
                            ;;
                    esac
                    shift
                done
                
                generate_content "$topic" "$template" "$count"
            else
                echo -e "${RED}Error: --topic parameter required for 'generate' command${NC}"
                show_help
                exit 1
            fi
            ;;
        "list")
            list_content
            ;;
        "schedule")
            local file_path=""
            local schedule_time=""
            local account="@default"
            
            shift
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --file=*)
                        file_path="${1#--file=}"
                        ;;
                    --time=*)
                        schedule_time="${1#--time=}"
                        ;;
                    --account=*)
                        account="${1#--account=}"
                        ;;
                esac
                shift
            done
            
            if [ -z "$file_path" ] || [ -z "$schedule_time" ]; then
                echo -e "${RED}Error: --file and --time parameters required for 'schedule' command${NC}"
                show_help
                exit 1
            fi
            
            schedule_content "$file_path" "$schedule_time" "$account"
            ;;
        "publish")
            local file_path=""
            local account="@default"
            
            shift
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --file=*)
                        file_path="${1#--file=}"
                        ;;
                    --account=*)
                        account="${1#--account=}"
                        ;;
                esac
                shift
            done
            
            if [ -z "$file_path" ]; then
                echo -e "${RED}Error: --file parameter required for 'publish' command${NC}"
                show_help
                exit 1
            fi
            
            publish_content "$file_path" "$account"
            ;;
        "template")
            if [[ "$2" == "--create" ]]; then
                local name=""
                local category=""
                local duration=""
                local style=""
                
                shift 2
                while [[ $# -gt 0 ]]; do
                    case $1 in
                        --name=*)
                            name="${1#--name=}"
                            ;;
                        --category=*)
                            category="${1#--category=}"
                            ;;
                        --duration=*)
                            duration="${1#--duration=}"
                            ;;
                        --style=*)
                            style="${1#--style=}"
                            ;;
                    esac
                    shift
                done
                
                if [ -z "$name" ] || [ -z "$category" ] || [ -z "$duration" ] || [ -z "$style" ]; then
                    echo -e "${RED}Error: All parameters required for template creation${NC}"
                    show_help
                    exit 1
                fi
                
                create_template "$name" "$category" "$duration" "$style"
            else
                echo -e "${RED}Error: Invalid template command${NC}"
                show_help
                exit 1
            fi
            ;;
        "templates")
            list_templates
            ;;
        "help"|*)
            show_help
            ;;
    esac
}

# Execute main function
main "$@"
