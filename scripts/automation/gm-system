#!/bin/bash
"""
Geeky Master System Control Tool
TikTok Automation System - System Management
"""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
PYTHON_SCRIPT="$PROJECT_ROOT/core/monitoring/dashboard.py"
LOG_DIR="$PROJECT_ROOT/data/logs"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${timestamp} [${level}] ${message}" | tee -a "$LOG_DIR/system_manager.log"
}

# Check system health
check_health() {
    log "INFO" "Performing system health check"
    
    echo -e "${BLUE}System Health Check${NC}"
    echo "========================================"
    
    local health_status=0
    
    # Check Python dependencies
    echo -e "${YELLOW}Checking Python dependencies...${NC}"
    local required_modules=("flask" "requests" "psutil")
    for module in "${required_modules[@]}"; do
        if python3 -c "import $module" 2>/dev/null; then
            echo -e "${GREEN}âœ“ $module${NC}"
        else
            echo -e "${RED}âœ— $module (missing)${NC}"
            health_status=1
        fi
    done
    
    echo ""
    
    # Check system tools
    echo -e "${YELLOW}Checking system tools...${NC}"
    local required_tools=("ffmpeg" "convert" "curl" "jq")
    for tool in "${required_tools[@]}"; do
        if command -v "$tool" &> /dev/null; then
            echo -e "${GREEN}âœ“ $tool${NC}"
        else
            echo -e "${RED}âœ— $tool (missing)${NC}"
            health_status=1
        fi
    done
    
    echo ""
    
    # Check directories
    echo -e "${YELLOW}Checking directories...${NC}"
    local required_dirs=("$PROJECT_ROOT/data/media" "$PROJECT_ROOT/data/logs" "/etc/gm-secrets")
    for dir in "${required_dirs[@]}"; do
        if [ -d "$dir" ]; then
            echo -e "${GREEN}âœ“ $dir${NC}"
        else
            echo -e "${RED}âœ— $dir (missing)${NC}"
            health_status=1
        fi
    done
    
    echo ""
    
    # Check API keys
    echo -e "${YELLOW}Checking API configuration...${NC}"
    if [ -f "/etc/gm-secrets/tiktok_keys.env" ] && [ -s "/etc/gm-secrets/tiktok_keys.env" ]; then
        local key_count=$(wc -l < "/etc/gm-secrets/tiktok_keys.env")
        echo -e "${GREEN}âœ“ TikTok API keys configured ($key_count keys)${NC}"
    else
        echo -e "${RED}âœ— No TikTok API keys configured${NC}"
        health_status=1
    fi
    
    # Check environment variables
    if [ -n "$OPENAI_API_KEY" ]; then
        echo -e "${GREEN}âœ“ OpenAI API key configured${NC}"
    else
        echo -e "${YELLOW}âš  OpenAI API key not configured (optional)${NC}"
    fi
    
    echo ""
    
    # Check disk space
    echo -e "${YELLOW}Checking disk space...${NC}"
    local disk_usage=$(df "$PROJECT_ROOT" | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$disk_usage" -lt 80 ]; then
        echo -e "${GREEN}âœ“ Disk usage: ${disk_usage}%${NC}"
    elif [ "$disk_usage" -lt 90 ]; then
        echo -e "${YELLOW}âš  Disk usage: ${disk_usage}% (warning)${NC}"
        health_status=1
    else
        echo -e "${RED}âœ— Disk usage: ${disk_usage}% (critical)${NC}"
        health_status=1
    fi
    
    echo ""
    
    # Check memory
    echo -e "${YELLOW}Checking memory usage...${NC}"
    local memory_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ "$memory_usage" -lt 80 ]; then
        echo -e "${GREEN}âœ“ Memory usage: ${memory_usage}%${NC}"
    elif [ "$memory_usage" -lt 90 ]; then
        echo -e "${YELLOW}âš  Memory usage: ${memory_usage}% (warning)${NC}"
        health_status=1
    else
        echo -e "${RED}âœ— Memory usage: ${memory_usage}% (critical)${NC}"
        health_status=1
    fi
    
    echo ""
    
    if [ $health_status -eq 0 ]; then
        echo -e "${GREEN}ðŸŽ‰ System is healthy!${NC}"
        log "SUCCESS" "System health check passed"
    else
        echo -e "${RED}âš ï¸ System has issues that need attention${NC}"
        log "WARNING" "System health check failed"
    fi
    
    return $health_status
}

# Show system status
show_status() {
    log "INFO" "Displaying system status"
    
    echo -e "${BLUE}System Status${NC}"
    echo "========================================"
    
    # System info
    echo -e "${YELLOW}System Information:${NC}"
    echo "OS: $(uname -s) $(uname -r)"
    echo "Uptime: $(uptime -p)"
    echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
    echo ""
    
    # Project info
    echo -e "${YELLOW}Project Information:${NC}"
    echo "Project Root: $PROJECT_ROOT"
    echo "Log Directory: $LOG_DIR"
    echo "Media Files: $(find "$PROJECT_ROOT/data/media" -name "*.mp4" 2>/dev/null | wc -l)"
    echo "API Keys: $(wc -l < /etc/gm-secrets/tiktok_keys.env 2>/dev/null || echo "0")"
    echo ""
    
    # Recent activity
    echo -e "${YELLOW}Recent Activity:${NC}"
    if [ -f "$LOG_DIR/system_manager.log" ]; then
        echo "Last 5 system events:"
        tail -n 5 "$LOG_DIR/system_manager.log" | while read line; do
            echo "  $line"
        done
    fi
    
    echo ""
    
    # Scheduled tasks
    echo -e "${YELLOW}Scheduled Tasks:${NC}"
    crontab -l 2>/dev/null | grep -E "(gm-|tiktok)" | while read line; do
        echo "  $line"
    done
}

# Heal system issues
heal_system() {
    log "INFO" "Starting system healing process"
    
    echo -e "${BLUE}System Healing Process${NC}"
    echo "========================================"
    
    # Fix missing directories
    echo -e "${YELLOW}Checking and creating directories...${NC}"
    local dirs=("$PROJECT_ROOT/data/media" "$PROJECT_ROOT/data/logs" "$PROJECT_ROOT/data/backups" "/etc/gm-secrets")
    for dir in "${dirs[@]}"; do
        if [ ! -d "$dir" ]; then
            if [ "$dir" = "/etc/gm-secrets" ]; then
                sudo mkdir -p "$dir"
                sudo chmod 700 "$dir"
            else
                mkdir -p "$dir"
            fi
            echo -e "${GREEN}âœ“ Created: $dir${NC}"
        fi
    done
    
    # Fix permissions
    echo -e "${YELLOW}Fixing permissions...${NC}"
    chmod +x "$SCRIPT_DIR"/* 2>/dev/null
    chmod 600 /etc/gm-secrets/* 2>/dev/null
    echo -e "${GREEN}âœ“ Permissions fixed${NC}"
    
    # Clean up old logs
    echo -e "${YELLOW}Cleaning up old logs...${NC}"
    find "$LOG_DIR" -name "*.log" -mtime +30 -delete 2>/dev/null
    echo -e "${GREEN}âœ“ Old logs cleaned${NC}"
    
    # Check and install missing packages
    echo -e "${YELLOW}Checking packages...${NC}"
    local missing_packages=()
    
    if ! command -v ffmpeg &> /dev/null; then
        missing_packages+=("ffmpeg")
    fi
    
    if ! command -v convert &> /dev/null; then
        missing_packages+=("imagemagick")
    fi
    
    if [ ${#missing_packages[@]} -gt 0 ]; then
        echo -e "${YELLOW}Installing missing packages: ${missing_packages[*]}${NC}"
        echo "Run: sudo apt update && sudo apt install -y ${missing_packages[*]}"
    else
        echo -e "${GREEN}âœ“ All required packages installed${NC}"
    fi
    
    # Restart services if needed
    echo -e "${YELLOW}Checking services...${NC}"
    # Add service checks here if needed
    
    log "SUCCESS" "System healing completed"
    echo -e "${GREEN}âœ“ System healing completed${NC}"
}

# Backup system
backup_system() {
    local backup_dir="$PROJECT_ROOT/data/backups"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$backup_dir/system_backup_$timestamp.tar.gz"
    
    log "INFO" "Creating system backup: $backup_file"
    
    echo -e "${BLUE}Creating System Backup${NC}"
    echo "========================================"
    
    mkdir -p "$backup_dir"
    
    # Create backup
    echo "Creating backup archive..."
    tar -czf "$backup_file" \
        -C "$(dirname "$PROJECT_ROOT")" \
        "$(basename "$PROJECT_ROOT")" \
        --exclude="$PROJECT_ROOT/data/media" \
        --exclude="$PROJECT_ROOT/data/logs" \
        --exclude="$PROJECT_ROOT/__pycache__" \
        --exclude="$PROJECT_ROOT/.git" \
        2>/dev/null
    
    if [ $? -eq 0 ]; then
        local backup_size=$(du -h "$backup_file" | cut -f1)
        echo -e "${GREEN}âœ“ Backup created: $backup_file ($backup_size)${NC}"
        log "SUCCESS" "Backup created: $backup_file"
        
        # Clean old backups (keep last 5)
        echo "Cleaning old backups..."
        cd "$backup_dir"
        ls -t system_backup_*.tar.gz | tail -n +6 | xargs -r rm
        echo -e "${GREEN}âœ“ Old backups cleaned${NC}"
    else
        echo -e "${RED}âœ— Backup failed${NC}"
        log "ERROR" "Backup creation failed"
        return 1
    fi
}

# Restore system
restore_system() {
    local backup_file="$1"
    
    if [ -z "$backup_file" ]; then
        echo -e "${RED}Error: Backup file required${NC}"
        echo "Usage: $0 restore --file=<backup_file>"
        return 1
    fi
    
    if [ ! -f "$backup_file" ]; then
        echo -e "${RED}Error: Backup file not found: $backup_file${NC}"
        return 1
    fi
    
    log "INFO" "Restoring system from: $backup_file"
    
    echo -e "${BLUE}Restoring System${NC}"
    echo "========================================"
    echo "This will overwrite the current system installation."
    echo "Backup file: $backup_file"
    echo ""
    
    read -p "Are you sure you want to continue? (y/N): " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Restore cancelled."
        return 0
    fi
    
    # Create backup of current system
    echo "Creating safety backup..."
    backup_system
    
    # Extract backup
    echo "Restoring from backup..."
    tar -xzf "$backup_file" -C "$(dirname "$PROJECT_ROOT")"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ System restored successfully${NC}"
        log "SUCCESS" "System restored from backup"
        
        # Run healing process
        heal_system
    else
        echo -e "${RED}âœ— Restore failed${NC}"
        log "ERROR" "System restore failed"
        return 1
    fi
}

# Start monitoring dashboard
start_dashboard() {
    local host="${1:-0.0.0.0}"
    local port="${2:-8080}"
    
    log "INFO" "Starting monitoring dashboard on $host:$port"
    
    echo -e "${BLUE}Starting Monitoring Dashboard${NC}"
    echo "========================================"
    
    if [ ! -f "$PYTHON_SCRIPT" ]; then
        echo -e "${RED}Error: Dashboard script not found${NC}"
        return 1
    fi
    
    # Install Flask if needed
    if ! python3 -c "import flask" 2>/dev/null; then
        echo "Installing Flask..."
        pip3 install flask
    fi
    
    cd "$PROJECT_ROOT"
    python3 "$PYTHON_SCRIPT" --host="$host" --port="$port"
}

# Show help
show_help() {
    echo -e "${BLUE}Geeky Master System Control Tool${NC}"
    echo ""
    echo "Usage: $0 [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo "  status                     Show system status"
    echo "  health                     Perform health check"
    echo "  heal                       Auto-heal system issues"
    echo "  backup                     Create system backup"
    echo "  restore --file=<backup>    Restore from backup"
    echo "  dashboard [--host=<ip>] [--port=<port>]  Start monitoring dashboard"
    echo "  help                       Show this help"
    echo ""
    echo "Examples:"
    echo "  $0 status"
    echo "  $0 health"
    echo "  $0 heal"
    echo "  $0 backup"
    echo "  $0 restore --file=./backups/system_backup_20240101_120000.tar.gz"
    echo "  $0 dashboard --host=127.0.0.1 --port=8080"
}

# Main execution
main() {
    # Create log directory
    mkdir -p "$LOG_DIR"
    
    # Parse command
    case "${1:-help}" in
        "status")
            show_status
            ;;
        "health")
            check_health
            ;;
        "heal")
            heal_system
            ;;
        "backup")
            backup_system
            ;;
        "restore")
            if [[ "$2" == --file=* ]]; then
                local backup_file="${2#--file=}"
                restore_system "$backup_file"
            else
                echo -e "${RED}Error: --file parameter required for 'restore' command${NC}"
                show_help
                exit 1
            fi
            ;;
        "dashboard")
            local host="0.0.0.0"
            local port="8080"
            
            shift
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --host=*)
                        host="${1#--host=}"
                        ;;
                    --port=*)
                        port="${1#--port=}"
                        ;;
                esac
                shift
            done
            
            start_dashboard "$host" "$port"
            ;;
        "help"|*)
            show_help
            ;;
    esac
}

# Execute main function
main "$@"
